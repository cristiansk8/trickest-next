// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            Int           @id @default(autoincrement())
  email         String        @unique
  username      String?       @unique // Username único para URLs públicas
  password      String? // Contraseña hasheada (opcional para usuarios de Google)
  name          String?
  phone         String? // Campo para el número de celular
  photo         String?
  estado        String?
  departamento  String?
  ciudad        String?
  birthdate     DateTime? // Nuevo campo para la fecha de nacimiento
  birthskate    DateTime? // Nuevo campo para la fecha de nacimiento
  profileStatus String        @default("basic") // "basic" (solo Google) | "complete" (perfil completo)
  role          String        @default("skater") // "skater" | "judge" | "admin"
  isActive      Boolean       @default(true) // Si el usuario está activo
  teamId        Int? // ID del equipo al que pertenece
  createdAt     DateTime      @default(now())
  socials       SocialMedia[] // Relación con la tabla de redes sociales
  WishSkate     WishSkate?
  submissions   Submission[] // Relación con los envíos de trucos
  evaluations   Submission[] @relation("JudgeEvaluations") // Evaluaciones hechas como juez
  ownedTeams    Team[]       @relation("TeamOwner") // Equipos que ha creado
  team          Team?        @relation("TeamMembers", fields: [teamId], references: [id])
  votes         Vote[] // Votos realizados por el usuario
  followers     Follow[]     @relation("UserFollowers") // Usuarios que me siguen
  following     Follow[]     @relation("UserFollowing") // Usuarios que sigo
}

model SocialMedia {
  id        Int     @id @default(autoincrement())
  userId    String  @unique // Username del usuario
  facebook  String?
  instagram String?
  tiktok    String?
  twitter   String?

  user User @relation(fields: [userId], references: [username]) // Relacionado por username
}

model WishSkate {
  id          Int     @id @default(autoincrement())
  userId      String  @unique // Username del usuario
  madero      String?
  trucks      String?
  ruedas      String?
  rodamientos String?
  tenis       String?

  user User @relation(fields: [userId], references: [username]) // Relacionado por username
}

model Challenge {
  id          Int          @id @default(autoincrement())
  level       Int // Nivel del reto (1-10, 0 para bonus)
  name        String // Nombre del truco (ej: "Ollie", "Kickflip")
  description String // Descripción del truco
  demoVideoUrl String // URL del video demo (YouTube)
  isBonus     Boolean      @default(false) // Si es un nivel bonus
  difficulty  String // "easy", "medium", "hard", "expert"
  points      Int          @default(100) // Puntos que otorga el truco
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  submissions Submission[] // Relación con los envíos de usuarios

  @@unique([level, isBonus]) // Solo puede haber un challenge por nivel (o un bonus)
}

model Submission {
  id           Int      @id @default(autoincrement())
  userId       String // Username del usuario
  challengeId  Int // ID del reto
  videoUrl     String // URL del video de YouTube del usuario
  status       String   @default("pending") // "pending", "approved", "rejected"
  score        Int? // Puntuación otorgada por el equipo (0-100)
  feedback     String? // Comentarios del equipo evaluador
  submittedAt  DateTime @default(now())
  evaluatedAt  DateTime? // Fecha de evaluación
  evaluatedBy  String? // Username del juez que evaluó

  // Campos de votación comunitaria
  upvotes          Int      @default(0) // Total de votos positivos
  downvotes        Int      @default(0) // Total de votos negativos
  voteCount        Int      @default(0) // Total de votos (upvotes + downvotes)
  communityApproved Boolean @default(false) // Si fue aprobado por la comunidad
  autoApprovedAt   DateTime? // Fecha de auto-aprobación por comunidad

  user      User      @relation(fields: [userId], references: [username])
  challenge Challenge @relation(fields: [challengeId], references: [id])
  judge     User?     @relation("JudgeEvaluations", fields: [evaluatedBy], references: [username])
  votes     Vote[] // Relación con los votos

  @@index([userId, challengeId])
  @@index([status])
  @@index([evaluatedBy])
  @@index([communityApproved])
  @@index([voteCount])
}

model Team {
  id          Int      @id @default(autoincrement())
  name        String   @unique // Nombre del equipo (único)
  description String? // Descripción del equipo
  logo        String? // URL del logo del equipo
  ownerId     String // Username del creador del equipo
  maxMembers  Int      @default(5) // Máximo de miembros permitidos
  isActive    Boolean  @default(true) // Si el equipo está activo
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner   User   @relation("TeamOwner", fields: [ownerId], references: [username])
  members User[] @relation("TeamMembers") // Miembros del equipo

  @@index([ownerId])
  @@index([isActive])
}

model Vote {
  id           Int      @id @default(autoincrement())
  submissionId Int // ID de la submission votada
  userId       String // Username del usuario que vota
  voteType     String // "upvote" o "downvote"
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [username])

  @@unique([submissionId, userId]) // Un usuario solo puede votar una vez por submission
  @@index([submissionId])
  @@index([userId])
  @@index([voteType])
}

model Follow {
  id          Int      @id @default(autoincrement())
  followerId  String // Username del usuario que sigue
  followingId String // Username del usuario seguido
  createdAt   DateTime @default(now())

  follower  User @relation("UserFollowers", fields: [followerId], references: [username])
  following User @relation("UserFollowing", fields: [followingId], references: [username])

  @@unique([followerId, followingId]) // Un usuario no puede seguir al mismo usuario dos veces
  @@index([followerId])
  @@index([followingId])
}

model InterestedUser {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
